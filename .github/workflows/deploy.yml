name: Deploy NetFlow Analyzer

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy Application
        run: |
          set -e
          echo "=========================================="
          echo "  Deploying NetFlow Analyzer"
          echo "  $(date)"
          echo "=========================================="

          APP_DIR="/opt/netflow-analyzer"

          # Create directory if not exists
          sudo mkdir -p $APP_DIR
          sudo chown $USER:$USER $APP_DIR

          # Copy latest code from checkout to app directory
          echo "Syncing code to $APP_DIR..."
          rsync -av --delete --exclude='.git' $GITHUB_WORKSPACE/ $APP_DIR/

          # Navigate to app directory
          cd $APP_DIR

          # Stop existing containers
          echo "Stopping existing containers..."
          sudo docker compose down 2>/dev/null || true

          # Build and start containers
          echo "Building and starting containers..."
          sudo docker compose build --no-cache
          sudo docker compose up -d

          # Wait for containers to be ready
          echo "Waiting for containers to be healthy..."
          sleep 20

          # Check status
          echo "Container status:"
          sudo docker compose ps

          # Health check
          APP_PORT="${APP_PORT:-8003}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$APP_PORT 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "Deployment successful! (HTTP $HTTP_CODE)"
          else
            echo "Warning: HTTP $HTTP_CODE - Check logs with: sudo docker compose logs"
          fi

          echo "=========================================="
          echo "  Deployment Complete!"
          echo "  Check your configured APP_URL"
          echo "=========================================="
