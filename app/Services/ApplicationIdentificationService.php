<?php

namespace App\Services;

class ApplicationIdentificationService
{
    /**
     * Well-known application IP ranges (CIDR notation)
     */
    protected array $ipRanges = [
        // Google/YouTube
        'Google' => [
            '8.8.4.0/24', '8.8.8.0/24', '8.34.208.0/20', '8.35.192.0/20',
            '34.64.0.0/10', '35.184.0.0/13', '35.192.0.0/14', '35.196.0.0/15',
            '35.198.0.0/16', '35.199.0.0/17', '35.199.128.0/18', '35.200.0.0/13',
            '35.208.0.0/12', '35.224.0.0/12', '35.240.0.0/13',
            '64.233.160.0/19', '66.102.0.0/20', '66.249.64.0/19',
            '70.32.128.0/19', '72.14.192.0/18', '74.125.0.0/16',
            '104.154.0.0/15', '104.196.0.0/14', '107.167.160.0/19',
            '107.178.192.0/18', '108.59.80.0/20', '108.170.192.0/18',
            '108.177.0.0/17', '130.211.0.0/16', '136.112.0.0/12',
            '142.250.0.0/15', '172.110.32.0/21', '172.217.0.0/16',
            '172.253.0.0/16', '173.194.0.0/16', '173.255.112.0/20',
            '192.158.28.0/22', '192.178.0.0/15', '193.186.4.0/24',
            '199.36.154.0/23', '199.36.156.0/24', '199.192.112.0/22',
            '199.223.232.0/21', '207.223.160.0/20', '208.65.152.0/22',
            '208.68.108.0/22', '208.81.188.0/22', '208.117.224.0/19',
            '209.85.128.0/17', '216.58.192.0/19', '216.73.80.0/20',
            '216.239.32.0/19',
        ],
        'YouTube' => [
            '208.117.252.0/24', '208.117.253.0/24', '208.117.254.0/24', '208.117.255.0/24',
            '208.65.153.0/24', '208.65.154.0/24', '208.117.236.0/24', '208.117.250.0/24',
            '209.85.128.0/17', '216.58.192.0/19',
        ],
        // Microsoft/Azure
        'Microsoft' => [
            '13.64.0.0/11', '13.96.0.0/13', '13.104.0.0/14',
            '20.0.0.0/11', '20.33.0.0/16', '20.34.0.0/15', '20.36.0.0/14',
            '20.40.0.0/13', '20.48.0.0/12', '20.64.0.0/10', '20.128.0.0/16',
            '23.96.0.0/13', '40.64.0.0/10', '40.128.0.0/12',
            '51.4.0.0/15', '51.8.0.0/16', '51.10.0.0/15', '51.12.0.0/15',
            '51.18.0.0/16', '51.51.0.0/16', '51.52.0.0/14', '51.103.0.0/16',
            '51.104.0.0/15', '51.107.0.0/16', '51.116.0.0/16', '51.120.0.0/16',
            '51.124.0.0/16', '51.132.0.0/16', '51.136.0.0/15', '51.138.0.0/16',
            '51.140.0.0/14', '51.144.0.0/15', '52.96.0.0/12', '52.112.0.0/14',
            '52.120.0.0/14', '52.125.0.0/16', '52.126.0.0/15', '52.130.0.0/15',
            '52.132.0.0/14', '52.136.0.0/13', '52.145.0.0/16', '52.146.0.0/15',
            '52.148.0.0/14', '52.152.0.0/13', '52.160.0.0/11', '52.224.0.0/11',
            '65.52.0.0/14', '70.37.0.0/17', '70.37.128.0/18',
            '104.40.0.0/13', '104.146.0.0/15', '104.208.0.0/13',
            '131.253.0.0/16', '132.245.0.0/16', '134.170.0.0/16',
            '137.116.0.0/15', '137.135.0.0/16', '138.91.0.0/16',
            '157.55.0.0/16', '157.56.0.0/14', '168.61.0.0/16', '168.62.0.0/15',
            '191.232.0.0/13', '199.30.16.0/20', '204.79.180.0/24',
            '207.46.0.0/16', '209.240.192.0/19',
        ],
        // Amazon/AWS
        'Amazon' => [
            '3.0.0.0/8', '13.32.0.0/15', '13.35.0.0/16', '13.48.0.0/15',
            '13.52.0.0/14', '13.56.0.0/14', '13.112.0.0/14', '13.124.0.0/14',
            '13.208.0.0/14', '13.224.0.0/14', '13.228.0.0/14', '13.232.0.0/14',
            '13.236.0.0/14', '13.244.0.0/15', '13.248.0.0/13', '15.177.0.0/18',
            '15.188.0.0/16', '15.193.0.0/16', '15.200.0.0/14', '15.206.0.0/15',
            '15.220.0.0/15', '15.222.0.0/16', '15.228.0.0/15', '15.230.0.0/15',
            '15.236.0.0/15', '15.248.0.0/13', '18.130.0.0/15', '18.132.0.0/14',
            '18.136.0.0/13', '18.144.0.0/15', '18.153.0.0/16', '18.156.0.0/14',
            '18.162.0.0/15', '18.175.0.0/16', '18.176.0.0/15', '18.178.0.0/15',
            '18.180.0.0/15', '18.182.0.0/16', '18.184.0.0/15', '18.188.0.0/14',
            '18.194.0.0/15', '18.196.0.0/15', '18.200.0.0/13', '18.208.0.0/13',
            '18.216.0.0/14', '18.220.0.0/14', '18.224.0.0/14', '18.228.0.0/15',
            '18.230.0.0/16', '18.231.0.0/16', '18.232.0.0/14', '18.236.0.0/15',
            '18.246.0.0/16', '18.248.0.0/13', '23.20.0.0/14', '34.192.0.0/10',
            '35.153.0.0/16', '35.154.0.0/15', '35.156.0.0/14', '35.160.0.0/13',
            '35.168.0.0/13', '35.176.0.0/15', '35.178.0.0/15', '35.180.0.0/15',
            '35.182.0.0/15', '44.192.0.0/10', '46.51.128.0/18', '46.51.192.0/20',
            '46.137.0.0/17', '50.16.0.0/15', '50.18.0.0/16', '50.19.0.0/16',
            '52.0.0.0/11', '52.32.0.0/11', '52.64.0.0/12', '52.80.0.0/14',
            '52.84.0.0/14', '52.88.0.0/13', '54.64.0.0/11', '54.144.0.0/12',
            '54.160.0.0/12', '54.176.0.0/13', '54.184.0.0/13', '54.192.0.0/12',
            '54.208.0.0/13', '54.216.0.0/14', '54.224.0.0/12', '54.240.0.0/12',
            '63.32.0.0/14', '63.176.0.0/14', '64.252.0.0/16', '67.202.0.0/18',
            '72.21.192.0/19', '72.44.32.0/19', '75.101.128.0/17',
            '76.223.0.0/17', '79.125.0.0/17', '87.238.80.0/21',
            '96.127.0.0/17', '99.77.128.0/18', '99.78.0.0/16', '99.79.0.0/16',
            '99.80.0.0/15', '99.82.128.0/17', '99.83.64.0/18', '99.83.128.0/17',
            '99.84.0.0/16', '99.86.0.0/16', '107.20.0.0/14', '107.176.0.0/15',
            '108.128.0.0/13', '108.166.224.0/20', '130.176.0.0/16',
            '143.204.0.0/16', '174.129.0.0/16', '175.41.128.0/18',
            '176.32.64.0/19', '176.34.0.0/16', '177.71.128.0/17',
            '184.72.0.0/15', '184.169.128.0/17', '185.48.120.0/22',
            '204.236.128.0/17', '204.246.160.0/19', '205.251.192.0/18',
            '207.171.160.0/19', '216.137.32.0/19', '216.182.224.0/20',
        ],
        // Netflix
        'Netflix' => [
            '23.246.0.0/18', '37.77.184.0/21', '45.57.0.0/17',
            '64.120.128.0/17', '66.197.128.0/17', '69.53.224.0/19',
            '108.175.32.0/20', '185.2.220.0/22', '185.9.188.0/22',
            '192.173.64.0/18', '198.38.96.0/19', '198.45.48.0/20',
            '208.75.76.0/22',
        ],
        // Facebook/Meta
        'Facebook' => [
            '31.13.24.0/21', '31.13.64.0/18', '45.64.40.0/22',
            '66.220.144.0/20', '69.63.176.0/20', '69.171.224.0/19',
            '74.119.76.0/22', '102.132.96.0/20', '103.4.96.0/22',
            '129.134.0.0/16', '147.75.208.0/20', '157.240.0.0/16',
            '173.252.64.0/18', '179.60.192.0/22', '185.60.216.0/22',
            '204.15.20.0/22',
        ],
        // GitHub
        'GitHub' => [
            '140.82.112.0/20', '143.55.64.0/20', '185.199.108.0/22',
            '192.30.252.0/22', '20.201.28.151/32', '20.205.243.166/32',
            '20.26.156.215/32', '20.27.177.113/32', '20.29.134.17/32',
            '20.87.245.0/24',
        ],
        // Cloudflare
        'Cloudflare' => [
            '103.21.244.0/22', '103.22.200.0/22', '103.31.4.0/22',
            '104.16.0.0/13', '104.24.0.0/14', '108.162.192.0/18',
            '131.0.72.0/22', '141.101.64.0/18', '162.158.0.0/15',
            '172.64.0.0/13', '173.245.48.0/20', '188.114.96.0/20',
            '190.93.240.0/20', '197.234.240.0/22', '198.41.128.0/17',
        ],
        // Spotify
        'Spotify' => [
            '35.186.224.0/20', '78.31.8.0/22', '193.182.8.0/22',
            '194.68.28.0/22', '194.68.169.0/24',
        ],
        // Zoom
        'Zoom' => [
            '3.7.35.0/25', '3.21.137.128/25', '3.22.11.0/24',
            '3.23.93.0/24', '3.25.41.128/25', '3.25.42.0/25',
            '3.25.49.0/24', '3.104.34.128/25', '3.120.121.0/25',
            '3.127.194.128/25', '4.34.125.128/25', '4.35.64.128/25',
            '8.5.128.0/24', '13.52.6.128/25', '13.52.146.0/25',
            '18.157.88.0/24', '20.203.158.80/28', '20.203.190.192/26',
            '50.239.202.0/23', '50.239.204.0/24', '52.61.100.128/25',
            '52.202.62.192/26', '52.215.168.0/25', '64.69.74.0/24',
            '64.211.144.0/24', '64.224.32.0/19', '65.39.152.0/24',
            '69.174.57.0/24', '69.174.108.0/22', '99.79.20.0/25',
            '101.36.167.0/24', '101.36.170.0/23', '103.122.166.0/23',
            '111.33.115.0/25', '111.33.181.0/25', '115.110.154.192/26',
            '115.114.56.192/26', '115.114.115.0/26', '115.114.131.0/26',
            '120.29.148.0/24', '129.151.0.0/19', '129.151.40.0/22',
            '140.238.128.0/24', '144.195.0.0/16', '147.124.96.0/19',
            '149.137.0.0/17', '152.67.20.0/24', '152.67.118.0/24',
            '152.67.168.0/22', '152.67.180.0/24', '152.67.184.0/22',
            '152.67.212.0/24', '152.70.0.0/17', '156.45.0.0/17',
            '158.101.64.0/24', '158.101.184.0/22', '160.1.56.128/25',
            '161.199.136.0/22', '162.12.232.0/22', '162.255.36.0/22',
            '165.254.88.0/23', '166.108.64.0/18', '168.138.16.0/22',
            '168.138.48.0/24', '168.138.56.0/21', '168.138.72.0/24',
            '168.138.74.0/24', '168.138.80.0/22', '168.138.96.0/22',
            '168.138.116.0/22', '168.138.244.0/24', '170.114.0.0/16',
            '173.231.80.0/20', '192.204.12.0/22', '193.122.16.0/20',
            '193.122.32.0/20', '193.122.208.0/20', '193.122.224.0/20',
            '193.123.0.0/19', '193.123.40.0/21', '193.123.128.0/19',
            '193.123.168.0/21', '193.123.192.0/19', '193.123.224.0/20',
            '198.251.128.0/17', '204.80.104.0/21', '204.141.28.0/22',
            '207.226.132.0/24', '209.9.211.0/24', '209.9.215.0/24',
            '213.19.144.0/24', '213.19.153.0/24', '213.244.140.0/24',
            '221.122.63.0/24', '221.122.64.0/24', '221.122.88.0/24',
            '221.122.89.0/24', '221.123.139.0/24',
        ],
        // Slack
        'Slack' => [
            '3.165.0.0/24', '13.32.68.0/22', '18.164.0.0/24', '54.192.195.0/24',
            '54.230.0.0/17', '54.230.128.0/18', '54.230.200.0/21',
            '54.239.128.0/18', '99.86.0.0/16', '130.211.0.0/16',
        ],
        // Discord
        'Discord' => [
            '66.22.196.0/22', '162.159.128.0/17', '66.22.230.0/24',
            '66.22.231.0/24', '66.22.232.0/24', '66.22.233.0/24',
        ],
        // Twitter/X
        'Twitter' => [
            '69.195.160.0/19', '104.244.40.0/21', '185.45.4.0/22',
            '192.133.76.0/22', '199.16.156.0/22', '199.59.148.0/22',
            '199.96.56.0/21',
        ],
        // LinkedIn
        'LinkedIn' => [
            '8.23.16.0/21', '8.23.119.0/24', '8.23.164.0/24', '91.225.248.0/23',
            '103.20.92.0/22', '108.174.0.0/20', '144.2.0.0/16', '185.63.144.0/22',
            '199.101.160.0/22', '216.52.16.0/20',
        ],
        // Twitch
        'Twitch' => [
            '52.223.192.0/18', '54.239.98.0/24', '99.181.64.0/21',
            '185.42.204.0/22', '192.108.150.0/24', '192.16.64.0/21',
            '199.9.248.0/21', '205.251.192.0/18',
        ],
        // TikTok
        'TikTok' => [
            '5.180.60.0/22', '161.117.96.0/19', '184.28.240.0/22',
            '192.229.162.0/24', '203.107.236.0/22',
        ],
        // Apple
        'Apple' => [
            '17.0.0.0/8', '63.92.224.0/19', '144.178.0.0/16', '192.35.50.0/24',
        ],
    ];

    /**
     * Port to application mappings
     */
    protected array $portMappings = [
        20 => 'FTP-DATA', 21 => 'FTP', 22 => 'SSH', 23 => 'Telnet', 25 => 'SMTP',
        53 => 'DNS', 67 => 'DHCP', 68 => 'DHCP', 69 => 'TFTP', 80 => 'HTTP',
        88 => 'Kerberos', 110 => 'POP3', 119 => 'NNTP', 123 => 'NTP',
        135 => 'RPC', 137 => 'NetBIOS', 138 => 'NetBIOS', 139 => 'NetBIOS',
        143 => 'IMAP', 161 => 'SNMP', 162 => 'SNMP-Trap', 179 => 'BGP',
        389 => 'LDAP', 443 => 'HTTPS', 445 => 'SMB', 465 => 'SMTPS',
        514 => 'Syslog', 515 => 'LPD', 520 => 'RIP', 587 => 'SMTP-Submission',
        636 => 'LDAPS', 853 => 'DNS-over-TLS', 873 => 'rsync', 993 => 'IMAPS',
        995 => 'POP3S', 1080 => 'SOCKS', 1194 => 'OpenVPN', 1433 => 'MSSQL',
        1434 => 'MSSQL', 1521 => 'Oracle', 1701 => 'L2TP', 1723 => 'PPTP',
        1812 => 'RADIUS', 1813 => 'RADIUS', 2049 => 'NFS', 2082 => 'cPanel',
        2083 => 'cPanel-SSL', 2086 => 'WHM', 2087 => 'WHM-SSL', 2095 => 'Webmail',
        2096 => 'Webmail-SSL', 3306 => 'MySQL', 3389 => 'RDP', 3478 => 'STUN',
        5060 => 'SIP', 5061 => 'SIP-TLS', 5222 => 'XMPP', 5223 => 'XMPP-SSL',
        5432 => 'PostgreSQL', 5900 => 'VNC', 5901 => 'VNC', 5902 => 'VNC',
        6379 => 'Redis', 8080 => 'HTTP-Alt', 8443 => 'HTTPS-Alt',
        9000 => 'PHP-FPM', 9200 => 'Elasticsearch', 11211 => 'Memcached',
        27017 => 'MongoDB', 27018 => 'MongoDB', 27019 => 'MongoDB',
    ];

    /**
     * Application icons and colors
     */
    protected array $appInfo = [
        'YouTube' => ['icon' => 'play-circle', 'color' => '#FF0000', 'category' => 'Streaming'],
        'Google' => ['icon' => 'search', 'color' => '#4285F4', 'category' => 'Search/Cloud'],
        'Facebook' => ['icon' => 'users', 'color' => '#1877F2', 'category' => 'Social Media'],
        'Netflix' => ['icon' => 'film', 'color' => '#E50914', 'category' => 'Streaming'],
        'Microsoft' => ['icon' => 'monitor', 'color' => '#00A4EF', 'category' => 'Productivity'],
        'Amazon' => ['icon' => 'cloud', 'color' => '#FF9900', 'category' => 'Cloud/E-commerce'],
        'GitHub' => ['icon' => 'github', 'color' => '#181717', 'category' => 'Development'],
        'Cloudflare' => ['icon' => 'shield', 'color' => '#F38020', 'category' => 'Security/CDN'],
        'Spotify' => ['icon' => 'music', 'color' => '#1DB954', 'category' => 'Streaming'],
        'Zoom' => ['icon' => 'video', 'color' => '#2D8CFF', 'category' => 'Communication'],
        'Slack' => ['icon' => 'message-square', 'color' => '#4A154B', 'category' => 'Communication'],
        'Discord' => ['icon' => 'message-circle', 'color' => '#5865F2', 'category' => 'Communication'],
        'Twitter' => ['icon' => 'hash', 'color' => '#1DA1F2', 'category' => 'Social Media'],
        'LinkedIn' => ['icon' => 'briefcase', 'color' => '#0A66C2', 'category' => 'Social Media'],
        'Twitch' => ['icon' => 'tv', 'color' => '#9146FF', 'category' => 'Streaming'],
        'TikTok' => ['icon' => 'smartphone', 'color' => '#000000', 'category' => 'Social Media'],
        'Apple' => ['icon' => 'smartphone', 'color' => '#555555', 'category' => 'Technology'],
        'HTTP' => ['icon' => 'globe', 'color' => '#6366F1', 'category' => 'Web'],
        'HTTPS' => ['icon' => 'lock', 'color' => '#10B981', 'category' => 'Web'],
        'DNS' => ['icon' => 'server', 'color' => '#8B5CF6', 'category' => 'Network'],
        'SSH' => ['icon' => 'terminal', 'color' => '#1F2937', 'category' => 'Remote Access'],
        'FTP' => ['icon' => 'file-text', 'color' => '#F59E0B', 'category' => 'File Transfer'],
        'SMTP' => ['icon' => 'mail', 'color' => '#EF4444', 'category' => 'Email'],
        'MySQL' => ['icon' => 'database', 'color' => '#4479A1', 'category' => 'Database'],
        'PostgreSQL' => ['icon' => 'database', 'color' => '#336791', 'category' => 'Database'],
        'RDP' => ['icon' => 'monitor', 'color' => '#0078D4', 'category' => 'Remote Access'],
        'VNC' => ['icon' => 'monitor', 'color' => '#444444', 'category' => 'Remote Access'],
        'Unknown' => ['icon' => 'help-circle', 'color' => '#6B7280', 'category' => 'Unknown'],
    ];

    /**
     * Identify application by IP address
     */
    public function identifyByIP(string $ip): ?string
    {
        foreach ($this->ipRanges as $app => $ranges) {
            foreach ($ranges as $range) {
                if ($this->ipInRange($ip, $range)) {
                    return $app;
                }
            }
        }
        return null;
    }

    /**
     * Identify application by port
     */
    public function identifyByPort(int $port): ?string
    {
        return $this->portMappings[$port] ?? null;
    }

    /**
     * Get application info (icon, color, category)
     */
    public function getApplicationInfo(string $application): array
    {
        return $this->appInfo[$application] ?? $this->appInfo['Unknown'];
    }

    /**
     * Analyze a flow and return application info
     */
    public function analyzeFlow(string $sourceIp, string $destIp, int $destPort = 0, ?string $existingApp = null): array
    {
        // First try existing application
        if ($existingApp && $existingApp !== 'Unknown') {
            $info = $this->getApplicationInfo($existingApp);
            return [
                'name' => $existingApp,
                'icon' => $info['icon'],
                'color' => $info['color'],
                'category' => $info['category'],
            ];
        }

        // Try to identify by destination IP
        $app = $this->identifyByIP($destIp);
        if (!$app) {
            // Try source IP
            $app = $this->identifyByIP($sourceIp);
        }

        // If still not found, try by port
        if (!$app && $destPort > 0) {
            $app = $this->identifyByPort($destPort);
        }

        // Default to Unknown
        if (!$app) {
            $app = 'Unknown';
        }

        $info = $this->getApplicationInfo($app);
        return [
            'name' => $app,
            'icon' => $info['icon'],
            'color' => $info['color'],
            'category' => $info['category'],
        ];
    }

    /**
     * Get all categories
     */
    public function getCategories(): array
    {
        return array_unique(array_column($this->appInfo, 'category'));
    }

    /**
     * Check if IP is in CIDR range
     */
    protected function ipInRange(string $ip, string $range): bool
    {
        if (strpos($range, '/') === false) {
            return $ip === $range;
        }

        [$subnet, $mask] = explode('/', $range);
        $mask = (int)$mask;

        $ipLong = ip2long($ip);
        $subnetLong = ip2long($subnet);

        if ($ipLong === false || $subnetLong === false) {
            return false;
        }

        $maskLong = -1 << (32 - $mask);
        return ($ipLong & $maskLong) === ($subnetLong & $maskLong);
    }
}
